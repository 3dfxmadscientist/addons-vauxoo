-
  Test sale order of products can be sold
-
    Create sale order, picking in and invoice by product
-
  !python {model: sale.order}: |
    import tools
    import netsvc
    import os
    import tempfile
    
    stringProductLog =['id, name, name_category, error']
    stringLog =['error']
    
    res_partner_obj = self.pool.get('res.partner')
    product_obj = self.pool.get('product.product')
    sale_order_line_obj = self.pool.get('sale.order.line')
    account_invoice_obj = self.pool.get('account.invoice')
    account_invoice_line_obj = self.pool.get('account.invoice.line')
    stock_picking_out_object = self.pool.get('stock.picking.out')
    product_ids = product_obj.search(cr, uid, [('sale_ok','=','True'), ('active','=','True')])
    invoice_id = None
    partner_id = None
    products_tax_not_fund = []
    partner_ids = res_partner_obj.search(cr, uid, [('customer','=','True')])
    if partner_ids:
        for partner in partner_ids:
            data = res_partner_obj.browse(cr, uid , [partner])[0]
            if data.property_account_payable.type :
                partner_id = data.id
                break
    assert  partner_id , 'Wrong, You can not generate a sale without a partner'
    
    if product_ids:
        for product_id in product_ids:
            product_data = product_obj.browse(cr, uid , [product_id])
            #~ Data of sale order
            sale_order_data = {'partner_id' : partner_id,
                               'payment_term' : ref('account_payment_term_sale_test_data_imp'),
                               'picking_policy': 'direct',
                               'order_policy': 'manual',
                               'pricelist_id': ref('list_test_sale_order_imp'),
                               'partner_invoice_id': partner_id,
                               'partner_shipping_id': partner_id,}

            #~ Data of sale order line
            sale_order_line_data = sale_order_line_obj.product_id_change(cr, uid, [], ref('list_test_sale_order_imp'), product_id, qty=1,
                uom=False, qty_uos=0, uos=False, name='', partner_id=partner_id,
                lang=False, update_tax=True, date_order=False, packaging=False, fiscal_position=False, flag=False, context=context)['value']

            #~ Added taxes of product
            taxes_ids = product_data[0].taxes_id
            sale_order_line_data.update({'product_id': product_id, 'tax_id': [(4, tax.id) for tax in taxes_ids]})
            
            #~ Added data of sale_order_line_data in sale_order_data
            sale_order_data.update({'order_line': [(0, 0, sale_order_line_data )]})
            
            #~ Create sale order with this product
            sale_order_id = self.create(cr, uid, sale_order_data )

            #~ Click button Confirm
            self.action_button_confirm(cr, uid, [sale_order_id],context=context)
            
            #~  Chech picking out by sale order
            if not product_data[0].type == 'service' :
                try:
                    stock_picking_out_ids = stock_picking_out_object.search(cr, uid, [('sale_id','=',sale_order_id)])
                    assert len(stock_picking_out_ids) > 0 ,  'Wrong. Stock picking out not fund'
                except Exception, e:
                    stringLogAux = ', '.join([tools.ustr(e).replace('\n', '')])
                    stringLog.append(stringLogAux)
            
            #~ Create invoice for this sale order
            try:
                #~ cr.execute("SAVEPOINT sale_order_savepoint")
                obj_sapi = self.pool.get('sale.advance.payment.inv')
                ctx = context.copy()
                ctx.update({"active_model": 'sale.order', "active_ids": [sale_order_id], "active_id": sale_order_id , 'open_invoices': True})
                pay_id = obj_sapi.create(cr, uid, {'advance_payment_method': 'all'})
                invoice_id = obj_sapi.create_invoices(cr, uid, [pay_id], context=ctx)
                #~ cr.execute("RELEASE SAVEPOINT sale_order_savepoint")
            except Exception, e:
                #~ cr.execute("ROLLBACK TO SAVEPOINT sale_order_savepoint")
                stringProductLogAux = ', '.join([repr(product_data[0].id),
                                              product_data[0].name.encode('utf8').replace(',','.'), 
                                              product_data[0].categ_id.name.encode('utf8').replace(',','.'),
                                              tools.ustr(e).replace('\n', '')])
                stringProductLog.append(stringProductLogAux)
                
            #~ Validate invoice for this sale order 
            if invoice_id:
                try:
                    wf_service = netsvc.LocalService("workflow")
                    wf_service.trg_validate(uid, 'account.invoice', invoice_id.get('res_id') , 'invoice_open', cr)
                except Exception, e:
                    stringLogAux = ', '.join([tools.ustr(e).replace('\n', '')])
                    stringLog.append(stringLogAux)
                
            #~ I check that the invoice lines tax_id not null
            #~ if invoice_id:
                #~ name_sale = self.browse(cr, uid, [sale_order_id])[0].name
                #~ invoice_ids = account_invoice_obj.search(cr, uid, [('origin','like',name_sale)])
                #~ invoice_lines_ids = account_invoice_line_obj.search(cr, uid ,  [('invoice_id','=',invoice_ids[0])])
                #~ if invoice_lines_ids:
                    #~ for line_id in invoice_lines_ids:
                        #~ line_data = account_invoice_line_obj.browse(cr, uid , [line_id])[0]
                        #~ tax_not_found = False
                        #~ taxes_ids = line_data.invoice_line_tax_id
                        #~ if len(taxes_ids) == 0:
                            #~ tax_not_found = True
                        #~ if tax_not_found == True:
                            #~ products_tax_not_fund.append(line_data.product_id.id)
                            
        set(stringProductLog)
        set(stringLog)
        if tools.config['test_report_directory']:
            open(os.path.join(tools.config['test_report_directory'], 'sale_order_product_log.csv'), 'wb+').write('\n'.join(stringProductLog))
            open(os.path.join(tools.config['test_report_directory'], 'sale_order_general_log.csv'), 'wb+').write('\n'.join(stringLog))
        else:
            tmp_path = tempfile.gettempdir()
            open(os.path.join(tmp_path, 'sale_order_product_log.csv'), 'wb+').write('\n'.join(stringProductLog))
            open(os.path.join(tmp_path, 'sale_order_general_log.csv'), 'wb+').write('\n'.join(stringLog))
        assert len(products_tax_not_fund) == 0 , 'Wrong. Some products not have tax : %s' % (products_tax_not_fund)
    
